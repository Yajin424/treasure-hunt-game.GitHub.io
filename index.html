<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神秘寻宝冒险</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background-color: #f0e6d2; 
            color: #333; 
            line-height: 1.6; 
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1, h2 { color: #8b4513; margin: 20px 0; text-align: center; }
        button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #6d3510; }
        .btn-secondary { background: #2c3e50; }
        .form-group { margin: 15px 0; }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .auth-form {
            max-width: 350px;
            margin: 50px auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .navbar {
            background: #8b4513;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-links a { color: white; margin: 0 10px; text-decoration: none; }
        .game-container {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .scene {
            height: 350px;
            background-size: cover;
            background-position: center;
            margin: 15px 0;
            border-radius: 5px;
        }
        .log {
            background: #f9f5eb;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid #8b4513;
        }
        .log-entry.error { border-left-color: #dc3545; color: #dc3545; }
        .locations {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }
        .location {
            text-align: center;
            cursor: pointer;
        }
        .location-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 24px;
            color: #8b4513;
        }
        .leaderboard {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        .audio-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .character {
            width: 60px;
            height: 80px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/2875/2875124.png');
            background-size: contain;
            background-repeat: no-repeat;
            position: relative;
            top: 270px;
            transition: left 2s;
            left: 50px;
        }
    </style>
</head>
<body>
    <div id="app">
        <router-view></router-view>
    </div>

    <script>
        // 状态管理
        const { createPinia, defineStore } = Pinia;
        const pinia = createPinia();

        const useGameStore = defineStore('game', {
            state: () => ({
                currentUser: null,
                users: JSON.parse(localStorage.getItem('treasureUsers')) || [],
                leaderboard: JSON.parse(localStorage.getItem('treasureLeaderboard')) || [],
                currentScene: 'library',
                progress: 0,
                logs: [],
                audio: { all: true }
            }),
            actions: {
                // 用户管理
                login(user, pass) {
                    const found = this.users.find(u => u.user === user && u.pass === pass);
                    if (found) {
                        this.currentUser = found;
                        this.loadProgress();
                        return true;
                    }
                    return false;
                },
                register(user, pass) {
                    if (this.users.some(u => u.user === user)) return false;
                    this.users.push({ user, pass, progress: 0, logs: [] });
                    localStorage.setItem('treasureUsers', JSON.stringify(this.users));
                    return true;
                },
                saveProgress() {
                    if (!this.currentUser) return;
                    const idx = this.users.findIndex(u => u.user === this.currentUser.user);
                    if (idx !== -1) {
                        this.users[idx].progress = this.progress;
                        this.users[idx].logs = this.logs;
                        localStorage.setItem('treasureUsers', JSON.stringify(this.users));
                    }
                },
                loadProgress() {
                    const user = this.users.find(u => u.user === this.currentUser.user);
                    if (user) {
                        this.progress = user.progress;
                        this.logs = user.logs || [];
                    }
                },
                // 游戏操作
                addLog(text, isError = false) {
                    this.logs.push({ text, isError, time: new Date() });
                    this.saveProgress();
                },
                reset() {
                    this.currentScene = 'library';
                    this.progress = 0;
                    this.logs = [];
                    this.saveProgress();
                },
                // 排行榜
                updateLeaderboard(time) {
                    if (!this.currentUser) return;
                    const score = 1000 - time;
                    this.leaderboard.push({
                        user: this.currentUser.user,
                        score,
                        time
                    });
                    this.leaderboard.sort((a, b) => b.score - a.score);
                    if (this.leaderboard.length > 10) this.leaderboard = this.leaderboard.slice(0, 10);
                    localStorage.setItem('treasureLeaderboard', JSON.stringify(this.leaderboard));
                }
            }
        });

        // 寻宝逻辑
        const TreasureMap = {
            clues: [
                "在古老的图书馆找到第一个线索: '穿过森林，寻找太阳神庙'",
                "解码成功: 森林位于东方三公里处",
                "成功穿越森林，前方出现古老神庙",
                "成功进入神庙，发现谜题机关",
                "谜题解开，出现通往地下的通道",
                "成功渡过地下河，发现神秘箱子",
                "恭喜! 找到传说中的宝藏!"
            ],
            getClue(idx) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (Math.random() > (idx > 2 ? 0.3 : 0.2)) {
                            resolve(this.clues[idx]);
                        } else {
                            reject("遭遇意外，任务失败!");
                        }
                    }, 1000);
                });
            }
        };

        // 组件
        const Navbar = {
            template: `
                <div class="navbar">
                    <h2>神秘寻宝冒险</h2>
                    <div class="nav-links">
                        <a @click.prevent="$router.push('/map')">地图</a>
                        <a @click.prevent="$router.push('/leaderboard')">排行榜</a>
                        <a @click.prevent="logout">退出</a>
                    </div>
                </div>
            `,
            methods: {
                logout() {
                    useGameStore().currentUser = null;
                    this.$router.push('/login');
                }
            }
        };

        const AudioControl = {
            template: `<div class="audio-control" @click="toggle">
                <i class="fa" :class="playing ? 'fa-volume-up' : 'fa-volume-off'"></i>
            </div>`,
            props: ['playing'],
            emits: ['toggle'],
            methods: { toggle() { this.$emit('toggle'); } }
        };

        const LogPanel = {
            template: `<div class="log">
                <div v-for="(log, i) in logs" :key="i" :class="['log-entry', log.isError ? 'error' : '']">
                    {{ log.text }}
                </div>
            </div>`,
            props: ['logs']
        };

        // 页面
        const LoginPage = {
            template: `
                <div class="container">
                    <div class="auth-form">
                        <h1>登录</h1>
                        <div class="form-group">
                            <input v-model="user" placeholder="用户名">
                        </div>
                        <div class="form-group">
                            <input v-model="pass" type="password" placeholder="密码">
                        </div>
                        <div>
                            <button @click="login">登录</button>
                            <button class="btn-secondary" @click="$router.push('/register')">注册</button>
                        </div>
                        <p v-if="error" style="color:red">{{ error }}</p>
                    </div>
                </div>
            `,
            data() { return { user: '', pass: '', error: '' }; },
            methods: {
                login() {
                    if (useGameStore().login(this.user, this.pass)) {
                        this.$router.push('/map');
                    } else {
                        this.error = '用户名或密码错误';
                    }
                }
            }
        };

        const RegisterPage = {
            template: `
                <div class="container">
                    <div class="auth-form">
                        <h1>注册</h1>
                        <div class="form-group">
                            <input v-model="user" placeholder="用户名">
                        </div>
                        <div class="form-group">
                            <input v-model="pass" type="password" placeholder="密码">
                        </div>
                        <button @click="register">注册</button>
                        <button class="btn-secondary" @click="$router.push('/login')">返回</button>
                        <p v-if="msg" :style="{color: success ? 'green' : 'red'}">{{ msg }}</p>
                    </div>
                </div>
            `,
            data() { return { user: '', pass: '', msg: '', success: false }; },
            methods: {
                register() {
                    if (useGameStore().register(this.user, this.pass)) {
                        this.msg = '注册成功';
                        this.success = true;
                        setTimeout(() => this.$router.push('/login'), 1000);
                    } else {
                        this.msg = '用户名已存在';
                        this.success = false;
                    }
                }
            }
        };

        const MapPage = {
            template: `
                <div>
                    <Navbar />
                    <div class="container">
                        <h1>选择目的地</h1>
                        <div class="locations">
                            <div class="location" @click="go('library')">
                                <div class="location-icon"><i class="fa fa-book"></i></div>
                                <div>古老图书馆</div>
                            </div>
                            <div class="location" @click="go('forest')">
                                <div class="location-icon"><i class="fa fa-tree"></i></div>
                                <div>迷雾森林</div>
                            </div>
                            <div class="location" @click="go('temple')">
                                <div class="location-icon"><i class="fa fa-university"></i></div>
                                <div>太阳神庙</div>
                            </div>
                            <div class="location" @click="go('puzzle')">
                                <div class="location-icon"><i class="fa fa-puzzle-piece"></i></div>
                                <div>谜题密室</div>
                            </div>
                            <div class="location" @click="go('river')">
                                <div class="location-icon"><i class="fa fa-tint"></i></div>
                                <div>地下暗河</div>
                            </div>
                            <div class="location" @click="go('treasure')">
                                <div class="location-icon"><i class="fa fa-diamond"></i></div>
                                <div>宝藏密室</div>
                            </div>
                        </div>
                        <AudioControl :playing="audioOn" @toggle="audioOn = !audioOn" />
                    </div>
                </div>
            `,
            components: { Navbar, AudioControl },
            data() { return { audioOn: true }; },
            methods: {
                go(scene) {
                    const store = useGameStore();
                    store.currentScene = scene;
                    this.$router.push('/game');
                }
            }
        };

        const GamePage = {
            template: `
                <div>
                    <Navbar />
                    <div class="container game-container">
                        <button class="btn-secondary" @click="$router.push('/map')">返回地图</button>
                        
                        <div class="scene" :style="sceneStyle">
                            <div class="character" :style="{left: charPos + 'px'}"></div>
                        </div>
                        
                        <div>{{ statusText }}</div>
                        <LogPanel :logs="logs" />
                        
                        <div>
                            <button :disabled="playing" @click="start">{{ btnText }}</button>
                            <button @click="reset">重置</button>
                        </div>
                        
                        <AudioControl :playing="audioOn" @toggle="audioOn = !audioOn" />
                    </div>
                </div>
            `,
            components: { Navbar, LogPanel, AudioControl },
            setup() {
                const store = useGameStore();
                const playing = Vue.ref(false);
                const charPos = Vue.ref(50);
                const audioOn = Vue.ref(true);
                const startTime = Vue.ref(0);

                const sceneImages = {
                    library: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa',
                    forest: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e',
                    temple: 'https://images.unsplash.com/photo-1604153559227-16e7f8371fd4',
                    puzzle: 'https://images.unsplash.com/photo-1551632811-561732d1e306',
                    river: 'https://images.unsplash.com/photo-1577427508551-122a38a4b6f3',
                    treasure: 'https://img95.699pic.com/photo/60039/9772.jpg_wh860.jpg'
                };

                const sceneStyle = Vue.computed(() => ({
                    backgroundImage: `url(${sceneImages[store.currentScene]})`
                }));

                const statusText = Vue.computed(() => {
                    const texts = [
                        "点击开始按钮，开始寻宝冒险！",
                        "已在图书馆找到线索，准备前往森林...",
                        "已穿越森林，前方是太阳神庙...",
                        "已进入神庙，发现谜题机关...",
                        "已解开谜题，找到地下通道...",
                        "已渡过地下河，发现神秘箱子...",
                        "恭喜！你已找到传说中的宝藏！"
                    ];
                    return texts[store.progress];
                });

                const btnText = Vue.computed(() => {
                    return playing.value ? "进行中..." : 
                           store.progress === 6 ? "再玩一次" : "开始冒险";
                });

                const moveCharacter = () => {
                    charPos.value = 50;
                    setTimeout(() => charPos.value = 600, 300);
                };

                const start = async () => {
                    if (store.progress === 6) {
                        store.reset();
                        return;
                    }

                    playing.value = true;
                    startTime.value = Date.now();
                    
                    try {
                        for (let i = store.progress; i < 6; i++) {
                            const scenes = ['library', 'forest', 'temple', 'puzzle', 'river', 'treasure'];
                            store.currentScene = scenes[i];
                            moveCharacter();
                            
                            const clue = await TreasureMap.getClue(i);
                            store.addLog(clue);
                            store.progress = i + 1;
                            
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }
                        
                        // 完成寻宝
                        const time = Math.floor((Date.now() - startTime.value) / 1000);
                        store.updateLeaderboard(time);
                    } catch (err) {
                        store.addLog(err, true);
                    } finally {
                        playing.value = false;
                    }
                };

                const reset = () => {
                    if (confirm("确定重置游戏？")) {
                        store.reset();
                    }
                };

                return {
                    sceneStyle,
                    statusText,
                    btnText,
                    logs: store.logs,
                    playing,
                    charPos,
                    audioOn,
                    start,
                    reset
                };
            }
        };

        const LeaderboardPage = {
            template: `
                <div>
                    <Navbar />
                    <div class="container">
                        <h1>寻宝排行榜</h1>
                        <div class="leaderboard">
                            <div class="leaderboard-item" v-for="(item, i) in leaderboard" :key="i">
                                <div>{{ i+1 }}. {{ item.user }}</div>
                                <div>得分: {{ item.score }} (用时: {{ item.time }}秒)</div>
                            </div>
                        </div>
                        <div style="text-align:center; margin-top:20px">
                            <button @click="$router.push('/map')">返回地图</button>
                        </div>
                    </div>
                </div>
            `,
            components: { Navbar },
            setup() {
                return { leaderboard: useGameStore().leaderboard };
            }
        };

        // 路由
        const { createRouter, createWebHashHistory } = VueRouter;
        const router = createRouter({
            history: createWebHashHistory(),
            routes: [
                { path: '/', redirect: '/login' },
                { path: '/login', component: LoginPage },
                { path: '/register', component: RegisterPage },
                { path: '/map', component: MapPage, beforeEnter: (to, from, next) => {
                    if (!useGameStore().currentUser) next('/login');
                    else next();
                }},
                { path: '/game', component: GamePage },
                { path: '/leaderboard', component: LeaderboardPage }
            ]
        });

        // 初始化应用
        const { createApp } = Vue;
        createApp({})
            .use(pinia)
            .use(router)
            .mount('#app');
    </script>
</body>
</html>
