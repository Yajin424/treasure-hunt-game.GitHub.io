<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神秘寻宝冒险 - Vue版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0e6d2;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* 通用样式 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: #8b4513;
            margin-bottom: 20px;
            text-align: center;
        }
        
        button {
            background-color: #8b4513;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        
        button:hover {
            background-color: #6d3510;
        }
        
        button:disabled {
            background-color: #a67c52;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background-color: #1a252f;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* 页面容器 */
        .page-container {
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .auth-form {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* 排行榜样式 */
        .leaderboard {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .leaderboard-header {
            background: #8b4513;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-item:nth-child(odd) {
            background: #f9f5eb;
        }
        
        .leaderboard-rank {
            font-weight: bold;
            width: 50px;
        }
        
        .leaderboard-name {
            flex-grow: 1;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #8b4513;
        }
        
        /* 导航栏 */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #8b4513;
            color: white;
            padding: 15px 20px;
            margin-bottom: 30px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        
        .nav-link:hover {
            opacity: 0.8;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            button {
                padding: 10px 16px;
                font-size: 14px;
                margin: 0 5px 10px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <router-view></router-view>
    </div>

    <script>
        // 1. 状态管理 (Pinia)
        const { createPinia, defineStore } = Pinia;
        const pinia = createPinia();

        // 游戏状态存储
        const useGameStore = defineStore('game', {
            state: () => ({
                currentUser: null,
                users: JSON.parse(localStorage.getItem('treasureUsers')) || [],
                leaderboard: JSON.parse(localStorage.getItem('treasureLeaderboard')) || [],
                currentScene: 'library',
                adventureProgress: 0,
                logEntries: [],
                audioStates: {
                    panorama: true,
                    library: true,
                    forest: true,
                    temple: true,
                    puzzle: true,
                    river: true,
                    treasure: true
                }
            }),
            actions: {
                // 用户管理
                login(username, password) {
                    const user = this.users.find(u => u.username === username && u.password === password);
                    if (user) {
                        this.currentUser = user;
                        return true;
                    }
                    return false;
                },
                
                register(username, password) {
                    if (this.users.some(u => u.username === username)) {
                        return false;
                    }
                    this.users.push({ username, password, lastLogin: new Date() });
                    this.saveUsers();
                    return true;
                },
                
                logout() {
                    this.currentUser = null;
                },
                
                saveUsers() {
                    localStorage.setItem('treasureUsers', JSON.stringify(this.users));
                },
                
                // 排行榜
                updateLeaderboard(time) {
                    if (!this.currentUser) return;
                    
                    const score = 10000 - time; // 用时越少分数越高
                    this.leaderboard.push({
                        username: this.currentUser.username,
                        score,
                        time,
                        date: new Date()
                    });
                    
                    // 排序并保留前10名
                    this.leaderboard.sort((a, b) => b.score - a.score);
                    if (this.leaderboard.length > 10) {
                        this.leaderboard = this.leaderboard.slice(0, 10);
                    }
                    
                    this.saveLeaderboard();
                },
                
                saveLeaderboard() {
                    localStorage.setItem('treasureLeaderboard', JSON.stringify(this.leaderboard));
                },
                
                // 游戏状态管理
                saveGameState() {
                    if (!this.currentUser) return;
                    
                    const userState = {
                        currentScene: this.currentScene,
                        adventureProgress: this.adventureProgress,
                        logEntries: this.logEntries,
                        audioStates: this.audioStates
                    };
                    
                    // 更新用户状态
                    const userIndex = this.users.findIndex(u => u.username === this.currentUser.username);
                    if (userIndex !== -1) {
                        this.users[userIndex].gameState = userState;
                        this.saveUsers();
                    }
                },
                
                loadUserGameState() {
                    if (!this.currentUser) return;
                    
                    const user = this.users.find(u => u.username === this.currentUser.username);
                    if (user && user.gameState) {
                        this.currentScene = user.gameState.currentScene;
                        this.adventureProgress = user.gameState.adventureProgress;
                        this.logEntries = user.gameState.logEntries;
                        this.audioStates = user.gameState.audioStates;
                    }
                },
                
                resetGame() {
                    this.currentScene = 'library';
                    this.adventureProgress = 0;
                    this.logEntries = [];
                    this.audioStates = {
                        panorama: true,
                        library: true,
                        forest: true,
                        temple: true,
                        puzzle: true,
                        river: true,
                        treasure: true
                    };
                    this.saveGameState();
                },
                
                // 游戏逻辑
                addLogEntry(content, isFailure = false) {
                    this.logEntries.push({
                        content,
                        isFailure,
                        time: new Date()
                    });
                    this.saveGameState();
                },
                
                updateAudioState(type, state) {
                    this.audioStates[type] = state;
                    this.saveGameState();
                },
                
                setCurrentScene(scene) {
                    this.currentScene = scene;
                    this.saveGameState();
                },
                
                setAdventureProgress(progress) {
                    this.adventureProgress = progress;
                    this.saveGameState();
                }
            }
        });

        // 2. 宝藏地图API服务
        const TreasureMap = {
            getInitialClue() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve("在古老的图书馆里找到了第一个线索...上面写着：'穿过森林，寻找太阳神庙'");
                    }, 1000);
                });
            },
            
            decodeAncientScript(clue) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (!clue) {
                            reject("没有线索可以解码!");
                        }
                        resolve("解码成功!根据线索，森林位于东方三公里处...");
                    }, 1500);
                });
            },
            
            crossForest() {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const random = Math.random();
                        if (random < 0.3) {
                            reject("在森林中遇到了凶猛的野兽，被迫返回！");
                        }
                        resolve("成功穿越森林，前方出现一座古老的神庙...");
                    }, 2000);
                });
            },
            
            searchTemple(location) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const random = Math.random();
                        if (random < 0.4) {
                            reject("糟糕!遇到了神庙守卫!");
                        }
                        resolve("成功进入神庙，发现一个谜题机关...");
                    }, 2000);
                });
            },
            
            solvePuzzle() {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const random = Math.random();
                        if (random < 0.3) {
                            reject("谜题解答错误，机关锁住了！");
                        }
                        resolve("谜题解开了，出现了一条通往地下的通道...");
                    }, 2500);
                });
            },
            
            crossRiver() {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const random = Math.random();
                        if (random < 0.25) {
                            reject("河流湍急，无法渡过！");
                        }
                        resolve("成功渡过地下河，发现一个神秘的箱子...");
                    }, 2000);
                });
            },
            
            openTreasureBox() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve("恭喜!你找到了传说中的宝藏!里面装满了黄金和珍贵的宝石！");
                    }, 1000);
                });
            }
        };

        // 3. 组件定义

        // 布局组件 - 导航栏
        const Navbar = {
            template: `
                <nav class="navbar">
                    <h2>神秘寻宝冒险</h2>
                    <div class="nav-links">
                        <a href="#" class="nav-link" @click.prevent="goToMap">地图</a>
                        <a href="#" class="nav-link" @click.prevent="goToLeaderboard">排行榜</a>
                        <a href="#" class="nav-link" @click.prevent="logout">退出登录</a>
                    </div>
                </nav>
            `,
            methods: {
                goToMap() {
                    this.$router.push('/map');
                },
                goToLeaderboard() {
                    this.$router.push('/leaderboard');
                },
                logout() {
                    const gameStore = useGameStore();
                    gameStore.logout();
                    this.$router.push('/login');
                }
            }
        };

        // 音频控制组件
        const AudioControl = {
            template: `
                <div class="audio-control" @click="toggleAudio">
                    <i v-if="isPlaying" class="fa fa-volume-up"></i>
                    <i v-else class="fa fa-volume-off"></i>
                </div>
            `,
            props: ['type', 'audioElement'],
            setup(props) {
                const gameStore = useGameStore();
                const isPlaying = Vue.computed(() => gameStore.audioStates[props.type]);
                
                const toggleAudio = () => {
                    const newState = !isPlaying.value;
                    gameStore.updateAudioState(props.type, newState);
                    
                    if (newState) {
                        props.audioElement.play().catch(e => {
                            console.log(`音频播放失败: ${e}`);
                        });
                    } else {
                        props.audioElement.pause();
                    }
                };
                
                return { isPlaying, toggleAudio };
            },
            style: `
                .audio-control {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    background-color: rgba(0,0,0,0.7);
                    color: #fff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5);
                    z-index: 10;
                    transition: background-color 0.3s;
                }
                .audio-control:hover {
                    background-color: rgba(0,0,0,0.9);
                }
                .audio-control i {
                    font-size: 1.5rem;
                }
            `
        };

        // 日志组件
        const AdventureLog = {
            template: `
                <div class="adventure-log">
                    <h3>冒险日志</h3>
                    <div v-for="(entry, index) in logEntries" :key="index" 
                         :class="['log-entry', entry.isFailure ? 'failure' : '']">
                        {{ entry.content }}
                    </div>
                </div>
            `,
            props: ['logEntries'],
            style: `
                .adventure-log {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f9f5eb;
                    border-radius: 5px;
                    max-height: 300px;
                    overflow-y: auto;
                }
                .log-entry {
                    margin: 10px 0;
                    padding: 10px;
                    border-left: 3px solid #8b4513;
                    background-color: rgba(255,255,255,0.7);
                    animation: fadeIn 0.5s ease-in;
                }
                .log-entry.failure {
                    border-left-color: #dc3545;
                    color: #dc3545;
                    font-weight: 500;
                }
            `
        };

        // 游戏场景组件
        const GameScene = {
            template: `
                <div class="game-animation">
                    <div v-for="scene in scenes" :key="scene.id" 
                         :id="scene.id" class="scene" 
                         :style="{ backgroundImage: \`url(\${scene.image})\` }"
                         :class="{ active: currentScene === scene.id }"></div>
                     
                    <div class="character" 
                         :class="{'facing-right': facingRight, 'facing-left': !facingRight}"
                         :style="{ left: characterPosition + '%' }"></div>
                </div>
            `,
            props: ['currentScene'],
            setup(props) {
                const characterPosition = Vue.ref(5);
                const facingRight = Vue.ref(true);
                const scenes = [
                    { id: 'library', image: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?ixlib=rb-4.0.3' },
                    { id: 'forest', image: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?ixlib=rb-4.0.3' },
                    { id: 'temple', image: 'https://images.unsplash.com/photo-1604153559227-16e7f8371fd4?ixlib=rb-4.0.3' },
                    { id: 'puzzle', image: 'https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-4.0.3' },
                    { id: 'river', image: 'https://images.unsplash.com/photo-1577427508551-122a38a4b6f3?ixlib=rb-4.0.3' },
                    { id: 'treasure', image: 'https://img95.699pic.com/photo/60039/9772.jpg_wh860.jpg' }
                ];

                // 监听场景变化，更新角色位置
                Vue.watch(() => props.currentScene, () => {
                    characterPosition.value = 5;
                    facingRight.value = true;
                    setTimeout(() => {
                        characterPosition.value = 70;
                    }, 500);
                });

                return { scenes, characterPosition, facingRight };
            },
            style: `
                .game-animation {
                    height: 400px;
                    margin: 20px 0;
                    border-radius: 5px;
                    overflow: hidden;
                    position: relative;
                    background-color: #e8e0d0;
                }
                .scene {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-size: cover;
                    background-position: center;
                    opacity: 0;
                    transition: opacity 1s ease-in-out;
                }
                .scene.active {
                    opacity: 1;
                }
                .character {
                    position: absolute;
                    width: 80px;
                    height: 100px;
                    bottom: 20px;
                    background-image: url('https://cdn-icons-png.flaticon.com/512/2875/2875124.png');
                    background-size: contain;
                    background-repeat: no-repeat;
                    transition: left 2s linear, transform 0.3s ease;
                    z-index: 5;
                }
                .character.facing-right {
                    transform: scaleX(1);
                }
                .character.facing-left {
                    transform: scaleX(-1);
                }
            `
        };

        // 地点标记组件
        const LocationMarker = {
            template: `
                <div class="location-marker" @click="handleClick">
                    <div class="marker-icon"><i :class="icon"></i></div>
                    <div class="marker-name">{{ name }}</div>
                </div>
            `,
            props: ['scene', 'name', 'icon'],
            methods: {
                handleClick() {
                    this.$emit('select', this.scene);
                }
            },
            style: `
                .location-marker {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    cursor: pointer;
                    transition: transform 0.3s ease;
                    position: relative;
                }
                .location-marker:hover {
                    transform: scale(1.1);
                }
                .marker-icon {
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    background-color: rgba(255,255,255,0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5);
                    margin-bottom: 15px;
                }
                .marker-icon i {
                    font-size: 2.5rem;
                    color: #8b4513;
                }
                .marker-name {
                    color: #fff;
                    font-size: 1.2rem;
                    text-shadow: 0 0 5px rgba(0,0,0,0.8);
                    background-color: rgba(0,0,0,0.5);
                    padding: 5px 15px;
                    border-radius: 20px;
                }
            `
        };

        // 4. 页面组件

        // 登录页面
        const LoginPage = {
            template: `
                <div class="page-container">
                    <div class="auth-form fade-in">
                        <h1>登录</h1>
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" id="username" v-model="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" id="password" v-model="password" required>
                        </div>
                        <div style="text-align: center;">
                            <button @click="handleLogin">登录</button>
                            <button class="btn-secondary" @click="goToRegister">注册</button>
                        </div>
                        <p v-if="error" style="color: red; text-align: center; margin-top: 15px;">
                            {{ error }}
                        </p>
                    </div>
                </div>
            `,
            data() {
                return {
                    username: '',
                    password: '',
                    error: ''
                };
            },
            methods: {
                handleLogin() {
                    const gameStore = useGameStore();
                    if (gameStore.login(this.username, this.password)) {
                        gameStore.loadUserGameState();
                        this.$router.push('/map');
                    } else {
                        this.error = '用户名或密码错误';
                    }
                },
                goToRegister() {
                    this.$router.push('/register');
                }
            }
        };

        // 注册页面
        const RegisterPage = {
            template: `
                <div class="page-container">
                    <div class="auth-form fade-in">
                        <h1>注册</h1>
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" id="username" v-model="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" id="password" v-model="password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">确认密码</label>
                            <input type="password" id="confirmPassword" v-model="confirmPassword" required>
                        </div>
                        <div style="text-align: center;">
                            <button @click="handleRegister">注册</button>
                            <button class="btn-secondary" @click="goToLogin">返回登录</button>
                        </div>
                        <p v-if="message" :style="{ color: isError ? 'red' : 'green', textAlign: 'center', marginTop: '15px' }">
                            {{ message }}
                        </p>
                    </div>
                </div>
            `,
            data() {
                return {
                    username: '',
                    password: '',
                    confirmPassword: '',
                    message: '',
                    isError: false
                };
            },
            methods: {
                handleRegister() {
                    if (this.password !== this.confirmPassword) {
                        this.message = '两次密码输入不一致';
                        this.isError = true;
                        return;
                    }
                    
                    if (!this.username || !this.password) {
                        this.message = '用户名和密码不能为空';
                        this.isError = true;
                        return;
                    }
                    
                    const gameStore = useGameStore();
                    if (gameStore.register(this.username, this.password)) {
                        this.message = '注册成功，请登录';
                        this.isError = false;
                        setTimeout(() => {
                            this.$router.push('/login');
                        }, 1000);
                    } else {
                        this.message = '用户名已存在';
                        this.isError = true;
                    }
                },
                goToLogin() {
                    this.$router.push('/login');
                }
            }
        };

        // 全景地图页面
        const MapPage = {
            template: `
                <div>
                    <Navbar />
                    <div class="panorama-page">
                        <h1 class="panorama-title">神秘寻宝冒险 - 选择目的地</h1>
                        <div class="location-markers">
                            <LocationMarker 
                                scene="library" 
                                name="古老图书馆" 
                                icon="fa fa-book" 
                                @select="handleSelectScene" />
                            <LocationMarker 
                                scene="forest" 
                                name="迷雾森林" 
                                icon="fa fa-tree" 
                                @select="handleSelectScene" />
                            <LocationMarker 
                                scene="temple" 
                                name="太阳神庙" 
                                icon="fa fa-university" 
                                @select="handleSelectScene" />
                            <LocationMarker 
                                scene="puzzle" 
                                name="谜题密室" 
                                icon="fa fa-puzzle-piece" 
                                @select="handleSelectScene" />
                            <LocationMarker 
                                scene="river" 
                                name="地下暗河" 
                                icon="fa fa-tint" 
                                @select="handleSelectScene" />
                            <LocationMarker 
                                scene="treasure" 
                                name="宝藏密室" 
                                icon="fa fa-diamond" 
                                @select="handleSelectScene" />
                        </div>
                        
                        <AudioControl 
                            type="panorama" 
                            :audio-element="panoramaAudio" />
                        <audio id="panoramaAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-15s.mp3" type="audio/mpeg">
                            您的浏览器不支持音频播放
                        </audio>
                    </div>
                </div>
            `,
            components: { Navbar, LocationMarker, AudioControl },
            data() {
                return {
                    panoramaAudio: null
                };
            },
            mounted() {
                this.panoramaAudio = document.getElementById('panoramaAudio');
                
                // 初始化音频
                const gameStore = useGameStore();
                if (gameStore.audioStates.panorama) {
                    this.panoramaAudio.play().catch(e => {
                        console.log("音频自动播放失败，需要用户交互:", e);
                    });
                }
            },
            methods: {
                handleSelectScene(scene) {
                    const gameStore = useGameStore();
                    gameStore.setCurrentScene(scene);
                    this.panoramaAudio.pause();
                    this.$router.push('/game');
                }
            },
            style: `
                .panorama-page {
                    position: relative;
                    min-height: calc(100vh - 70px);
                    background-image: url('https://images.unsplash.com/photo-1518655048521-f130df041f66?ixlib=rb-4.0.3');
                    background-size: cover;
                    background-position: center;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                .panorama-title {
                    color: #fff;
                    font-size: 3rem;
                    text-shadow: 0 0 15px rgba(0,0,0,0.8);
                    margin-bottom: 50px;
                    text-align: center;
                }
                .location-markers {
                    display: flex;
                    gap: 80px;
                    flex-wrap: wrap;
                    justify-content: center;
                    max-width: 1200px;
                    padding: 0 20px;
                }
                @media (max-width: 768px) {
                    .panorama-title {
                        font-size: 2rem;
                    }
                    .location-markers {
                        gap: 40px;
                    }
                }
            `
        };

        // 游戏页面
        const GamePage = {
            template: `
                <div>
                    <Navbar />
                    <div class="container game-container">
                        <button class="back-to-panorama" @click="goToMap">
                            <i class="fa fa-map-marker"></i> 返回地图
                        </button>
                        
                        <h1>神秘寻宝冒险</h1>
                        
                        <GameScene :current-scene="currentScene" />
                        
                        <div class="game-status" :class="statusClass">
                            {{ statusText }}
                        </div>
                        
                        <AdventureLog :log-entries="logEntries" />
                        
                        <div class="controls">
                            <button :disabled="isPlaying" @click="startTreasureHunt">
                                {{ playButtonText }}
                            </button>
                            <button @click="resetGame">重置游戏</button>
                        </div>
                        
                        <AudioControl 
                            :type="currentScene" 
                            :audio-element="currentSceneAudio" />
                            
                        <!-- 场景音频元素 -->
                        <audio id="libraryAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-6s.mp3" type="audio/mpeg">
                        </audio>
                        <audio id="forestAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-9s.mp3" type="audio/mpeg">
                        </audio>
                        <audio id="templeAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-12s.mp3" type="audio/mpeg">
                        </audio>
                        <audio id="puzzleAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-18s.mp3" type="audio/mpeg">
                        </audio>
                        <audio id="riverAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-21s.mp3" type="audio/mpeg">
                        </audio>
                        <audio id="treasureAudio" loop>
                            <source src="https://samplelib.com/lib/preview/mp3/sample-24s.mp3" type="audio/mpeg">
                        </audio>
                    </div>
                </div>
            `,
            components: { Navbar, GameScene, AdventureLog, AudioControl },
            setup() {
                const gameStore = useGameStore();
                const currentScene = Vue.computed(() => gameStore.currentScene);
                const adventureProgress = Vue.computed(() => gameStore.adventureProgress);
                const logEntries = Vue.computed(() => gameStore.logEntries);
                const isPlaying = Vue.ref(false);
                const startTime = Vue.ref(0);
                
                // 获取当前场景的音频元素
                const currentSceneAudio = Vue.computed(() => {
                    return document.getElementById(`${currentScene.value}Audio`);
                });
                
                // 播放按钮文本
                const playButtonText = Vue.computed(() => {
                    if (isPlaying.value) return "冒险进行中...";
                    if (adventureProgress.value === 7) return "再次寻宝";
                    return "开始寻宝";
                });
                
                // 状态文本
                const statusText = Vue.computed(() => {
                    const texts = [
                        "点击开始按钮，开始你的寻宝冒险！",
                        "已在图书馆找到初始线索，准备前往森林...",
                        "已穿越森林，前方是太阳神庙...",
                        "已进入神庙，发现谜题机关...",
                        "已解开谜题，找到地下通道...",
                        "已渡过地下河，发现神秘箱子...",
                        "准备打开宝藏箱，见证奇迹时刻...",
                        "恭喜！你已找到传说中的宝藏！"
                    ];
                    return texts[adventureProgress.value] || texts[0];
                });
                
                // 状态样式
                const statusClass = Vue.computed(() => {
                    return gameStore.adventureProgress === 7 ? 'success' : '';
                });
                
                // 切换场景
                const switchScene = (sceneId) => {
                    // 停止当前场景音频
                    if (currentSceneAudio.value) {
                        currentSceneAudio.value.pause();
                    }
                    
                    // 更新场景
                    gameStore.setCurrentScene(sceneId);
                    
                    // 播放新场景音频（如果启用）
                    setTimeout(() => {
                        const newAudio = document.getElementById(`${sceneId}Audio`);
                        if (newAudio && gameStore.audioStates[sceneId]) {
                            newAudio.play().catch(e => {
                                console.log(`音频播放失败（${sceneId}）：`, e);
                            });
                        }
                    }, 500);
                };
                
                // 开始寻宝
                const startTreasureHunt = async () => {
                    if (adventureProgress.value === 7) {
                        gameStore.resetGame();
                        return;
                    }
                    
                    isPlaying.value = true;
                    startTime.value = new Date().getTime();
                    
                    try {
                        // 步骤1：图书馆（进度0→1）
                        if (adventureProgress.value < 1) {
                            switchScene('library');
                            gameStore.addLogEntry("正在图书馆寻找线索...");
                            
                            const clue = await TreasureMap.getInitialClue();
                            gameStore.addLogEntry(clue);
                            gameStore.setAdventureProgress(1);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // 步骤2：解码线索
                        gameStore.addLogEntry("正在解码古老线索...");
                        const decoded = await TreasureMap.decodeAncientScript("图书馆线索");
                        gameStore.addLogEntry(decoded);
                        await new Promise(resolve => setTimeout(resolve, 1500));

                        // 步骤3：森林（进度1→2）
                        if (adventureProgress.value < 2) {
                            switchScene('forest');
                            gameStore.addLogEntry("准备穿越迷雾森林...");
                            
                            const forestResult = await TreasureMap.crossForest();
                            gameStore.addLogEntry(forestResult);
                            gameStore.setAdventureProgress(2);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // 步骤4：神庙（进度2→3）
                        if (adventureProgress.value < 3) {
                            switchScene('temple');
                            gameStore.addLogEntry("正在探索太阳神庙...");
                            
                            const templeResult = await TreasureMap.searchTemple('forest');
                            gameStore.addLogEntry(templeResult);
                            gameStore.setAdventureProgress(3);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // 步骤5：谜题（进度3→4）
                        if (adventureProgress.value < 4) {
                            switchScene('puzzle');
                            gameStore.addLogEntry("正在解开神庙谜题...");
                            
                            const puzzleResult = await TreasureMap.solvePuzzle();
                            gameStore.addLogEntry(puzzleResult);
                            gameStore.setAdventureProgress(4);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // 步骤6：河流（进度4→5）
                        if (adventureProgress.value < 5) {
                            switchScene('river');
                            gameStore.addLogEntry("准备渡过地下暗河...");
                            
                            const riverResult = await TreasureMap.crossRiver();
                            gameStore.addLogEntry(riverResult);
                            gameStore.setAdventureProgress(5);
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // 步骤7：宝藏（进度5→6→7）
                        if (adventureProgress.value < 7) {
                            switchScene('treasure');
                            gameStore.addLogEntry("准备打开宝藏箱...");
                            
                            const treasureResult = await TreasureMap.openTreasureBox();
                            gameStore.addLogEntry(treasureResult);
                            gameStore.setAdventureProgress(7);
                            
                            // 记录完成时间并更新排行榜
                            const endTime = new Date().getTime();
                            const timeTaken = Math.floor((endTime - startTime.value) / 1000);
                            gameStore.updateLeaderboard(timeTaken);
                        }

                    } catch (error) {
                        gameStore.addLogEntry(`失败: ${error}`, true);
                    } finally {
                        isPlaying.value = false;
                    }
                };
                
                // 重置游戏
                const resetGame = () => {
                    if (confirm("确定要重置游戏吗？所有进度将被清除！")) {
                        // 停止当前音频
                        if (currentSceneAudio.value) {
                            currentSceneAudio.value.pause();
                        }
                        gameStore.resetGame();
                    }
                };
                
                // 返回地图
                const goToMap = () => {
                    // 停止当前音频
                    if (currentSceneAudio.value) {
                        currentSceneAudio.value.pause();
                    }
                    router.push('/map');
                };
                
                return {
                    currentScene,
                    logEntries,
                    isPlaying,
                    playButtonText,
                    statusText,
                    statusClass,
                    currentSceneAudio,
                    startTreasureHunt,
                    resetGame,
                    goToMap
                };
            },
            style: `
                .game-container {
                    background-color: rgba(255, 255, 255, 0.9);
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.3);
                    min-height: calc(100vh - 70px);
                    padding-top: 70px;
                }
                .game-status {
                    min-height: 100px;
                    margin: 20px 0;
                    padding: 20px;
                    border-radius: 5px;
                    background-color: #fff;
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.1rem;
                }
                .game-status.success {
                    color: #28a745;
                    font-weight: bold;
                }
                .controls {
                    text-align: center;
                    margin: 30px 0;
                }
                .back-to-panorama {
                    background-color: #2c3e50;
                    position: absolute;
                    top: 90px;
                    left: 20px;
                    z-index: 10;
                }
                @media (max-width: 768px) {
                    .game-container {
                        padding: 20px;
                        padding-top: 60px;
                    }
                    .back-to-panorama {
                        top: 100px;
                    }
                }
            `
        };

        // 排行榜页面
        const LeaderboardPage = {
            template: `
                <div>
                    <Navbar />
                    <div class="container">
                        <h1>寻宝高手排行榜</h1>
                        <div class="leaderboard">
                            <div class="leaderboard-header">
                                <h2>排名前10的寻宝大师</h2>
                            </div>
                            <div v-if="leaderboard.length === 0" style="text-align: center; padding: 20px;">
                                暂无记录，快来成为第一个寻宝大师吧！
                            </div>
                            <div v-for="(entry, index) in leaderboard" :key="index" class="leaderboard-item">
                                <div class="leaderboard-rank">
                                    {{ index + 1 }}.
                                    <span v-if="index < 3" :style="{ color: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : '#CD7F32' }">
                                        <i class="fa fa-trophy"></i>
                                    </span>
                                </div>
                                <div class="leaderboard-name">{{ entry.username }}</div>
                                <div class="leaderboard-score">
                                    得分: {{ entry.score }} (用时: {{ entry.time }}秒)
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button @click="goToMap">返回地图</button>
                        </div>
                    </div>
                </div>
            `,
            components: { Navbar },
            setup() {
                const gameStore = useGameStore();
                const leaderboard = Vue.computed(() => gameStore.leaderboard);
                
                const goToMap = () => {
                    router.push('/map');
                };
                
                return { leaderboard, goToMap };
            }
        };

        // 5. 路由配置
        const { createRouter, createWebHashHistory } = VueRouter;

        // 路由守卫：检查是否登录
        const requireAuth = (to, from, next) => {
            const gameStore = useGameStore();
            if (!gameStore.currentUser) {
                next('/login');
            } else {
                next();
            }
        };

        const routes = [
            { path: '/', redirect: '/login' },
            { path: '/login', component: LoginPage },
            { path: '/register', component: RegisterPage },
            { path: '/map', component: MapPage, beforeEnter: requireAuth },
            { path: '/game', component: GamePage, beforeEnter: requireAuth },
            { path: '/leaderboard', component: LeaderboardPage, beforeEnter: requireAuth }
        ];

        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // 6. 创建并挂载应用
        const { createApp } = Vue;
        const app = createApp({});
        
        app.use(pinia);
        app.use(router);
        
        // 全局注册组件
        app.component('Navbar', Navbar);
        app.component('AudioControl', AudioControl);
        app.component('AdventureLog', AdventureLog);
        app.component('GameScene', GameScene);
        app.component('LocationMarker', LocationMarker);
        
        app.mount('#app');
    </script>
</body>
</html>
